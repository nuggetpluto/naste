{% extends "base.html" %}
{% block content %}

<h2>–ñ–∏–≤–æ—Ç–Ω—ã–µ</h2>

<form method="get" action="/animals" style="margin-bottom: 15px; display:flex; gap:10px; align-items:center;">
    <div>
        <label>–ü–æ–∏—Å–∫ –ø–æ –≤–∏–¥—É:</label>
        <input type="text" name="species" value="{{ filter_species }}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–µ–±—Ä–∞">
    </div>

    <div>
        <label>–ü–æ–ª:</label>
        <select name="gender">
            <option value="">–õ—é–±–æ–π</option>
            <option value="–º" {% if filter_gender == "–º" %}selected{% endif %}>–º</option>
            <option value="–∂" {% if filter_gender == "–∂" %}selected{% endif %}>–∂</option>
        </select>
    </div>

    <button type="submit" class="btn btn-primary">–ù–∞–π—Ç–∏</button>

    {% if filter_species or filter_gender %}
        <a href="/animals" class="btn" style="margin-left:10px;">–°–±—Ä–æ—Å–∏—Ç—å</a>
    {% endif %}
</form>

{% if user.role == 'manager' %}
    <p><a href="/animals/add" class="btn">–î–æ–±–∞–≤–∏—Ç—å –∂–∏–≤–æ—Ç–Ω–æ–µ</a></p>
{% endif %}

<table border="1" cellpadding="8" cellspacing="0" style="width:100%;">
    <tr>
        <th>‚Ññ</th>
        <th>–í–∏–¥</th>
        <th>–ö–ª–∏—á–∫–∞</th>
        <th>–í–æ–∑—Ä–∞—Å—Ç</th>
        <th>–ü–æ–ª</th>
        <th>–î–∞—Ç–∞ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</th>
        <th>–°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è</th>
        <th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
        <th>–†–∞—Ü–∏–æ–Ω</th>
    </tr>

    {% for a in animals %}
    <tr>
        <td>{{ loop.index }}</td>
        <td>{{ a.species }}</td>
        <td>{{ a.name }}</td>
        <td>{{ a.age }}</td>
        <td>{{ a.gender }}</td>
        <td>{{ a.admission_date }}</td>

        <!-- üìå –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è -->
        <td>
    <div id="cell-{{ a.id }}" style="display:flex; align-items:center; gap:6px;">

        {% if a.health_status == "–£–º–µ—Ä" %}
            <!-- ‚ùå –£–º–µ—Ä ‚Äî –º–µ–Ω—è—Ç—å –Ω–µ–ª—å–∑—è -->
            <span style="color: red; font-weight: bold;">–£–º–µ—Ä</span>
        {% else %}
            <!-- ‚úî –ñ–∏–≤ ‚Äî –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å -->
            <span id="text-{{ a.id }}">{{ a.health_status }}</span>

            <button onclick="showSelect({{ a.id }})"
                    style="background:none; border:none; cursor:pointer; font-size:18px;">
                ‚úèÔ∏è
            </button>

            <select id="select-{{ a.id }}"
                    onchange="saveStatus({{ a.id }})"
                    style="display:none; padding:3px;">
                {% set options = ["–ó–¥–æ—Ä–æ–≤", "–õ–µ—á–∏—Ç—Å—è", "–í—ã–∑–¥–æ—Ä–æ–≤–µ–ª", "–£–º–µ—Ä"] %}
                {% for st in options %}
                    <option value="{{ st }}" {% if a.health_status == st %}selected{% endif %}>
                        {{ st }}
                    </option>
                {% endfor %}
            </select>
        {% endif %}

    </div>
</td>

        <td>{{ a.employee_name if a.employee_name else "-" }}</td>
        <td>{{ a.ration }}</td>
    </tr>
    {% endfor %}
</table>

{% if not animals %}
<p>–ñ–∏–≤–æ—Ç–Ω—ã—Ö –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
{% endif %}

<script>

/* üü° –ü–æ—è–≤–ª–µ–Ω–∏–µ select –ø–æ –∫–ª–∏–∫—É */
function showSelect(id) {
    document.getElementById("text-" + id).style.display = "none";
    const select = document.getElementById("select-" + id);
    select.style.display = "inline-block";
    select.focus();
}

/* üü¢ AJAX ‚Äì —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
async function saveStatus(id) {
    const select = document.getElementById(`select-${id}`);
    const status = select.value;

    try {
        const response = await fetch(`/animals/update_health_ajax/${id}`, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `status=${encodeURIComponent(status)}`
        });

        const data = await response.json();

        if (!data.success) {
            alert("–û—à–∏–±–∫–∞: " + data.error);
            return;
        }

        // ‚¨Ö –≤–µ—Ä–Ω—É—Ç—å —Ç–µ–∫—Å—Ç –∏ —Å–∫—Ä—ã—Ç—å select
        document.getElementById("text-" + id).innerText = status;
        document.getElementById("text-" + id).style.display = "inline-block";
        select.style.display = "none";

    } catch (error) {
        alert("–û—à–∏–±–∫–∞: " + error.message);
    }
}

</script>

{% endblock %}